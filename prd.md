**1. 简介**

本 PRD 旨在定义 habit track 应用中新增的 iCloud 同步功能。该功能将允许 PRO 用户在多个 Apple 设备之间自动同步其习惯数据，包括习惯的创建、编辑、删除以及打卡记录。这将提升用户体验，避免数据丢失，并提供更便捷的数据管理方式。

**2. 目标**

* 为 PRO 用户提供无缝的跨设备习惯数据同步体验。
* 消除用户手动导入导出数据的需求。
* 在用户卸载并重新安装应用后，能够恢复其习惯数据。
* 提升 PRO 版本的价值，吸引更多用户购买。

**3. 用户故事**

* 作为一名 PRO 用户，我希望在我的 iPhone 上创建或编辑的习惯能够自动同步到我的 iPad 上，这样我可以在任何设备上查看和管理我的习惯。
* 作为一名 PRO 用户，我希望在我的 iPhone 或 iPad 上进行的打卡操作能够实时同步到其他设备上，确保我的所有设备上的数据都是最新的。
* 作为一名 PRO 用户，如果我不小心卸载了应用并在重新安装后恢复购买，我希望我的所有习惯数据能够自动从 iCloud 恢复，而不会丢失任何进度。
* 作为一名 PRO 用户，我希望在应用的设置页面能够清楚地看到 iCloud 同步的状态，例如是否已开启、正在同步或同步失败。
* 作为一名 PRO 用户，当我的本地数据与云端数据发生冲突时，我希望应用能够提示我，并允许我选择保留本地数据还是云端数据。

**4. 功能需求**

**4.1 自动开启与状态显示**

* 当用户购买 PRO 版本后，iCloud 同步功能应自动开启。
* 允许用户手动触发同步。
* 在应用的设置页面中，应提供一个清晰的区域显示 iCloud 同步的当前状态。可能的状态包括：
    * 已开启并正常同步
    * 正在同步
    * 同步失败（并显示可能的错误信息）
    * 未开启（仅在用户未购买 PRO 版本时显示）

**4.2 习惯数据同步**

* **创建习惯:** 在一个设备上创建的新习惯应自动同步到其他已登录同一 iCloud 账户并安装了 PRO 版本的设备上。
* **编辑习惯:** 在一个设备上对习惯进行的编辑（例如修改名称、类型、目标次数等）应自动同步到其他设备。
* **删除习惯:** 在一个设备上删除的习惯应自动从其他设备上移除。

**4.3 打卡数据同步**

* **Checkbox 类型习惯:** 在任何设备或 widget 上进行的 Checkbox 操作应立即同步到其他设备。
* **Count 类型习惯:** 在任何设备或 widget 上进行的打卡计数增加操作应立即同步到其他设备。

**4.4 首次安装与重装恢复**

* **首次安装:** 如果用户是首次安装应用，且之前没有使用过 PRO 版本，则正常启动应用并允许用户创建新的习惯。
* **卸载后重装:**
    * 应用启动时，应首先尝试恢复用户的 in-app purchase 记录，以确定用户是否拥有 PRO 版本。
    * 在恢复购买流程完成并确认用户是 PRO 版本后， 应用应检查该用户的 iCloud 账户中是否存在该应用的历史数据。
    * 如果存在历史数据，应用应提示用户存在 icloud数据，并由用户选择是否进行恢复。
    * 如果用户成功恢复购买，但 iCloud 中不存在历史数据（例如用户是首次购买 PRO 版本并在重装后首次使用），则正常启动应用并允许用户创建新的习惯。
    * 如果用户选择不恢复，则删除 icloud 中数据，并正常启动应用并允许用户创建新的习惯。用户新建习惯后，会自动同步到 icloud。
    * 在恢复购买流程进行中，应用可以显示一个提示信息，告知用户正在检查其 PRO 版本状态。

**4.5 数据冲突处理**

* 当本地数据与云端数据发生冲突时（例如，在两个设备离线状态下同时修改了同一个习惯），应用应采取以下策略：
    * 弹窗或页面提示用户发生数据冲突。
    * 向用户展示本地版本和云端版本的冲突数据（例如，习惯的最后修改时间或者具体的差异，这里显示的数据尽可能简单）。
    * 提供选项让用户选择保留本地版本或云端版本。
    * 用户选择后，应用应将选定的版本作为最终版本并同步到其他设备。
* 对于每一个冲突的习惯，都采用上述流程，交由用户手动选择。

**5. 非功能需求**

* **可靠性:** iCloud 同步功能应稳定可靠，保证数据同步的准确性和及时性。
* **性能:** 同步过程应尽可能在后台进行，不影响用户正常使用应用。
* **安全性:** 利用 CloudKit 的安全机制保障用户数据的安全。
* **用户体验:** 同步过程对用户应该是透明的，状态显示清晰易懂。

**6. 成功指标**

* PRO 用户中 iCloud 同步功能的启用率。
* 用户关于数据同步稳定性和易用性的反馈。
* 因数据丢失或同步问题导致的用户投诉数量。
