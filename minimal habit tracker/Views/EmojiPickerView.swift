import SwiftUI

// Emojié€‰æ‹©å™¨è§†å›¾
struct EmojiPickerView: View {
    @Binding var selectedEmoji: String
    @Binding var selectedBackgroundColor: String
    @Environment(\.presentationMode) var presentationMode
    @State private var searchText = ""
    @State private var selectedTab = 0 // 0è¡¨ç¤ºEmojiï¼Œ1è¡¨ç¤ºText
    @State private var tempSelectedEmoji: String // ä¸´æ—¶å­˜å‚¨é€‰ä¸­çš„emojiï¼Œä»…åœ¨ç¡®è®¤æ—¶æ‰æ›´æ–°ç»‘å®šå€¼
    @State private var selectedCategoryIndex = 0
    @State private var textInput = ""
    @State private var recentEmojis: [String] = []
    // æ·»åŠ å½“å‰åˆ†ç±»çš„emojiæ•°æ®
    @State private var currentCategoryEmojis: [String] = []
    
    // æœ€è¿‘ä½¿ç”¨çš„emojiçš„UserDefaultsé”®
    private let recentEmojisKey = "recentEmojis"
    // æœ€è¿‘ä½¿ç”¨çš„emojiçš„æœ€å¤§æ•°é‡
    private let maxRecentEmojis = 30
    
    // åˆå§‹åŒ–ä¸´æ—¶é€‰ä¸­çš„emoji
    init(selectedEmoji: Binding<String>, selectedBackgroundColor: Binding<String>) {
        self._selectedEmoji = selectedEmoji
        self._selectedBackgroundColor = selectedBackgroundColor
        self._tempSelectedEmoji = State(initialValue: selectedEmoji.wrappedValue)
        self._recentEmojis = State(initialValue: Self.loadRecentEmojis())
        // ä¸å†åœ¨åˆå§‹åŒ–æ—¶åŠ è½½æ‰€æœ‰emojiæ•°æ®
    }
    
    // ä»UserDefaultsåŠ è½½æœ€è¿‘ä½¿ç”¨çš„emoji
    private static func loadRecentEmojis() -> [String] {
        if let savedEmojis = UserDefaults.standard.array(forKey: "recentEmojis") as? [String] {
            return savedEmojis
        } else {
            // é»˜è®¤emojiåˆ—è¡¨
            return ["ğŸ˜€", "ğŸ˜Š", "ğŸ‘", "â¤ï¸", "ğŸ‰", "ğŸ”¥", "âœ¨", "ğŸ™", "ğŸ‘‹", "ğŸ¤”"]
        }
    }
    
    // ä¿å­˜emojiåˆ°æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
    private func saveEmojiToRecents(_ emoji: String) {
        // å¦‚æœemojiå·²ç»åœ¨åˆ—è¡¨ä¸­ï¼Œå…ˆç§»é™¤
        var updatedRecents = recentEmojis.filter { $0 != emoji }
        
        // å°†æ–°emojiæ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
        updatedRecents.insert(emoji, at: 0)
        
        // å¦‚æœåˆ—è¡¨è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œæˆªæ–­
        if updatedRecents.count > maxRecentEmojis {
            updatedRecents = Array(updatedRecents.prefix(maxRecentEmojis))
        }
        
        // æ›´æ–°çŠ¶æ€å’Œå­˜å‚¨
        self.recentEmojis = updatedRecents
        UserDefaults.standard.set(updatedRecents, forKey: recentEmojisKey)
    }
    
    // é¡¶éƒ¨å›¾æ ‡ç±»åˆ« - æ·»åŠ SF Symbolså›¾æ ‡
    let topIcons = ["clock", "person", "leaf", "gift", "building.2", "number"]
    
    // è¡¨æƒ…ç¬¦å·åˆ†ç±»å®šä¹‰ - åç§°å’Œå›¾æ ‡
    let emojiCategoryDefinitions: [(name: String, symbol: String)] = [
        ("æœ€è¿‘ä½¿ç”¨", "clock"),
        ("äººç‰©", "person"),
        ("è‡ªç„¶", "leaf"),
        ("ç‰©å“", "gift"),
        ("åœ°ç‚¹", "building.2"),
        ("ç¬¦å·", "number")
    ]
    
    // æ ¹æ®åˆ†ç±»ç´¢å¼•è·å–å¯¹åº”çš„emojiæ•°ç»„
    private func getEmojisForCategory(_ index: Int) -> [String] {
        switch index {
        case 0: return recentEmojis // æœ€è¿‘ä½¿ç”¨
        case 1: return [
            // People ç±»åˆ«çš„è¡¨æƒ…ç¬¦å·
            "ğŸ˜€", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜", "ğŸ˜†", "ğŸ˜…", "ğŸ˜‚", "ğŸ¤£", "â˜ºï¸", "ğŸ˜Š",
            "ğŸ˜‡", "ğŸ™‚", "ğŸ™ƒ", "ğŸ˜‰", "ğŸ˜Œ", "ğŸ˜", "ğŸ¥°", "ğŸ˜˜", "ğŸ˜—", "ğŸ˜™",
            "ğŸ˜š", "ğŸ˜‹", "ğŸ˜›", "ğŸ˜", "ğŸ˜œ", "ğŸ¤ª", "ğŸ¤¨", "ğŸ§", "ğŸ¤“", "ğŸ˜",
            "ğŸ˜", "ğŸ˜’", "ğŸ˜", "ğŸ˜”", "ğŸ˜Ÿ", "ğŸ˜•", "ğŸ™", "â˜¹ï¸", "ğŸ˜£", "ğŸ˜–",
            "ğŸ˜«", "ğŸ˜©", "ğŸ¥º", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜¤", "ğŸ˜ ", "ğŸ˜¡", "ğŸ¤¬", "ğŸ¤¯",
            "ğŸ˜³", "ğŸ¥µ", "ğŸ¥¶", "ğŸ˜±", "ğŸ˜¨", "ğŸ˜°", "ğŸ˜¥", "ğŸ˜“", "ğŸ¤—", "ğŸ¤”",
            "ğŸ¤­", "ğŸ¤«", "ğŸ¤¥", "ğŸ˜¶", "ğŸ˜", "ğŸ˜‘", "ğŸ˜¬", "ğŸ™„", "ğŸ˜¯", "ğŸ˜¦",
            "ğŸ˜§", "ğŸ˜®", "ğŸ˜²", "ğŸ¥±", "ğŸ˜´", "ğŸ¤¤", "ğŸ˜ª", "ğŸ˜µ", "ğŸ¤", "ğŸ¥´",
            "ğŸ¤¢", "ğŸ¤®", "ğŸ¤§", "ğŸ˜·", "ğŸ¤’", "ğŸ¤•", "ğŸ¤‘", "ğŸ¤ ", "ğŸ‘‹", "ğŸ¤š",
            "âœ‹", "ğŸ––", "ğŸ‘Œ", "ğŸ¤", "âœŒï¸", "ğŸ¤", "ğŸ¤Ÿ", "ğŸ¤˜", "ğŸ¤™", "ğŸ‘ˆ",
            "ğŸ‘‰", "ğŸ‘†", "ğŸ–•", "ğŸ‘‡", "â˜ï¸", "ğŸ‘", "ğŸ‘", "âœŠ", "ğŸ‘Š", "ğŸ¤›",
            "ğŸ¤œ", "ğŸ‘", "ğŸ™Œ", "ğŸ‘", "ğŸ¤²", "ğŸ¤", "ğŸ™", "ğŸ’ª", "ğŸ¦¾", "ğŸ¦¿",
            "ğŸ¦µ", "ğŸ¦¶", "ğŸ‘£", "ğŸ‘‚", "ğŸ¦»", "ğŸ‘ƒ", "ğŸ§ ", "ğŸ¦·", "ğŸ‘€", "ğŸ‘ï¸",
            "ğŸ‘…", "ğŸ‘„", "ğŸ’‹", "â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ’™", "ğŸ’œ", "ğŸ¤",
            "ğŸ–¤", "ğŸ¤", "ğŸ’”", "â£ï¸", "ğŸ’•", "ğŸ’", "ğŸ’“", "ğŸ’—", "ğŸ’–", "ğŸ’˜",
            "ğŸ’", "ğŸ’Ÿ", "ğŸ‘¶", "ğŸ‘§", "ğŸ§’", "ğŸ‘¦", "ğŸ‘©", "ğŸ§‘", "ğŸ‘¨", "ğŸ‘©â€ğŸ¦±",
            "ğŸ‘¨â€ğŸ¦±", "ğŸ‘©â€ğŸ¦°", "ğŸ‘¨â€ğŸ¦°", "ğŸ‘±â€â™€ï¸", "ğŸ‘±", "ğŸ‘±â€â™‚ï¸", "ğŸ‘©â€ğŸ¦³", "ğŸ‘¨â€ğŸ¦³", "ğŸ‘©â€ğŸ¦²", "ğŸ‘¨â€ğŸ¦²",
            "ğŸ§”", "ğŸ‘µ", "ğŸ§“", "ğŸ‘´", "ğŸ‘®â€â™€ï¸", "ğŸ‘®", "ğŸ‘®â€â™‚ï¸", "ğŸ‘·â€â™€ï¸", "ğŸ‘·", "ğŸ‘·â€â™‚ï¸",
            "ğŸ’‚â€â™€ï¸", "ğŸ’‚", "ğŸ’‚â€â™‚ï¸", "ğŸ•µï¸â€â™€ï¸", "ğŸ•µï¸", "ğŸ•µï¸â€â™‚ï¸", "ğŸ‘©â€âš•ï¸", "ğŸ§‘â€âš•ï¸", "ğŸ‘¨â€âš•ï¸", "ğŸ‘©â€ğŸŒ¾",
            "ğŸ§‘â€ğŸŒ¾", "ğŸ‘¨â€ğŸŒ¾", "ğŸ‘©â€ğŸ³", "ğŸ§‘â€ğŸ³", "ğŸ‘¨â€ğŸ³", "ğŸ‘©â€ğŸ“", "ğŸ§‘â€ğŸ“", "ğŸ‘¨â€ğŸ“", "ğŸ‘©â€ğŸ¤", "ğŸ§‘â€ğŸ¤",
            "ğŸ‘¨â€ğŸ¤", "ğŸ‘©â€ğŸ«", "ğŸ§‘â€ğŸ«", "ğŸ‘¨â€ğŸ«", "ğŸ‘©â€ğŸ­", "ğŸ§‘â€ğŸ­", "ğŸ‘¨â€ğŸ­", "ğŸ‘©â€ğŸ’»", "ğŸ§‘â€ğŸ’»", "ğŸ‘¨â€ğŸ’»",
            "ğŸ‘©â€ğŸ’¼", "ğŸ§‘â€ğŸ’¼", "ğŸ‘¨â€ğŸ’¼", "ğŸ‘©â€ğŸ”§", "ğŸ§‘â€ğŸ”§", "ğŸ‘¨â€ğŸ”§", "ğŸ‘©â€ğŸ”¬", "ğŸ§‘â€ğŸ”¬", "ğŸ‘¨â€ğŸ”¬", "ğŸ‘©â€ğŸ¨",
            "ğŸ§‘â€ğŸ¨", "ğŸ‘¨â€ğŸ¨", "ğŸ‘©â€ğŸš’", "ğŸ§‘â€ğŸš’", "ğŸ‘¨â€ğŸš’", "ğŸ‘©â€âœˆï¸", "ğŸ§‘â€âœˆï¸", "ğŸ‘¨â€âœˆï¸", "ğŸ‘©â€ğŸš€", "ğŸ§‘â€ğŸš€",
            "ğŸ‘¨â€ğŸš€", "ğŸ‘©â€âš–ï¸", "ğŸ§‘â€âš–ï¸", "ğŸ‘¨â€âš–ï¸", "ğŸ‘°", "ğŸ¤µ", "ğŸ¤´", "ğŸ‘¸", "ğŸ¦¸â€â™€ï¸", "ğŸ¦¸",
            "ğŸ¦¸â€â™‚ï¸", "ğŸ¦¹â€â™€ï¸", "ğŸ¦¹", "ğŸ¦¹â€â™‚ï¸", "ğŸ¤¶", "ğŸ…", "ğŸ§™â€â™€ï¸", "ğŸ§™", "ğŸ§™â€â™‚ï¸", "ğŸ§â€â™€ï¸",
            "ğŸ§", "ğŸ§â€â™‚ï¸", "ğŸ§›â€â™€ï¸", "ğŸ§›", "ğŸ§›â€â™‚ï¸", "ğŸ§Ÿâ€â™€ï¸", "ğŸ§Ÿ", "ğŸ§Ÿâ€â™‚ï¸", "ğŸ§â€â™€ï¸", "ğŸ§",
            "ğŸ§â€â™‚ï¸", "ğŸ§œâ€â™€ï¸", "ğŸ§œ", "ğŸ§œâ€â™‚ï¸", "ğŸ§šâ€â™€ï¸", "ğŸ§š", "ğŸ§šâ€â™‚ï¸", "ğŸ‘¼", "ğŸ¤°", "ğŸ¤±",
            "ğŸ™‡â€â™€ï¸", "ğŸ™‡", "ğŸ™‡â€â™‚ï¸", "ğŸ’â€â™€ï¸", "ğŸ’", "ğŸ’â€â™‚ï¸", "ğŸ™…â€â™€ï¸", "ğŸ™…", "ğŸ™…â€â™‚ï¸", "ğŸ™†â€â™€ï¸",
            "ğŸ™†", "ğŸ™†â€â™‚ï¸", "ğŸ™‹â€â™€ï¸", "ğŸ™‹", "ğŸ™‹â€â™‚ï¸", "ğŸ§â€â™€ï¸", "ğŸ§", "ğŸ§â€â™‚ï¸", "ğŸ¤¦â€â™€ï¸", "ğŸ¤¦",
            "ğŸ¤¦â€â™‚ï¸", "ğŸ¤·â€â™€ï¸", "ğŸ¤·", "ğŸ¤·â€â™‚ï¸", "ğŸ™â€â™€ï¸", "ğŸ™", "ğŸ™â€â™‚ï¸", "ğŸ™â€â™€ï¸", "ğŸ™", "ğŸ™â€â™‚ï¸",
            "ğŸ’‡â€â™€ï¸", "ğŸ’‡", "ğŸ’‡â€â™‚ï¸", "ğŸ’†â€â™€ï¸", "ğŸ’†", "ğŸ’†â€â™‚ï¸", "ğŸ§–â€â™€ï¸", "ğŸ§–", "ğŸ§–â€â™‚ï¸", "ğŸ’…",
            "ğŸ¤³", "ğŸ’ƒ", "ğŸ•º", "ğŸ‘¯â€â™€ï¸", "ğŸ‘¯", "ğŸ‘¯â€â™‚ï¸", "ğŸ•´ï¸", "ğŸ‘©â€ğŸ¦½", "ğŸ§‘â€ğŸ¦½", "ğŸ‘¨â€ğŸ¦½",
            "ğŸ‘©â€ğŸ¦¼", "ğŸ§‘â€ğŸ¦¼", "ğŸ‘¨â€ğŸ¦¼", "ğŸš¶â€â™€ï¸", "ğŸš¶", "ğŸš¶â€â™‚ï¸", "ğŸ‘©â€ğŸ¦¯", "ğŸ§‘â€ğŸ¦¯", "ğŸ‘¨â€ğŸ¦¯", "ğŸ§â€â™€ï¸",
            "ğŸ§", "ğŸ§â€â™‚ï¸", "ğŸƒâ€â™€ï¸", "ğŸƒ", "ğŸƒâ€â™‚ï¸", "ğŸ§â€â™€ï¸", "ğŸ§", "ğŸ§â€â™‚ï¸", "ğŸ‘­", "ğŸ§‘â€ğŸ¤â€ğŸ§‘",
            "ğŸ‘¬", "ğŸ‘«", "ğŸ‘©â€â¤ï¸â€ğŸ‘©", "ğŸ’‘", "ğŸ‘¨â€â¤ï¸â€ğŸ‘¨", "ğŸ‘©â€â¤ï¸â€ğŸ‘¨", "ğŸ‘©â€â¤ï¸â€ğŸ’‹â€ğŸ‘©", "ğŸ’", "ğŸ‘¨â€â¤ï¸â€ğŸ’‹â€ğŸ‘¨", "ğŸ‘©â€â¤ï¸â€ğŸ’‹â€ğŸ‘¨",
            "ğŸ‘ª", "ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦", "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§", "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", "ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦", "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘§", "ğŸ‘¨â€ğŸ‘¨â€ğŸ‘¦", "ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§", "ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦", "ğŸ‘¨â€ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦",
            "ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§â€ğŸ‘§", "ğŸ‘©â€ğŸ‘©â€ğŸ‘¦", "ğŸ‘©â€ğŸ‘©â€ğŸ‘§", "ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", "ğŸ‘©â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦", "ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘§", "ğŸ‘¨â€ğŸ‘¦", "ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦", "ğŸ‘¨â€ğŸ‘§", "ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦",
            "ğŸ‘¨â€ğŸ‘§â€ğŸ‘§", "ğŸ‘©â€ğŸ‘¦", "ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦", "ğŸ‘©â€ğŸ‘§", "ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", "ğŸ‘©â€ğŸ‘§â€ğŸ‘§", "ğŸ—£ï¸", "ğŸ‘¤", "ğŸ‘¥", "ğŸ«‚"
        ]
        case 2: return [
            // Nature ç±»åˆ«çš„è¡¨æƒ…ç¬¦å·
            "ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ»â€â„ï¸", "ğŸ¨",
            "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ½", "ğŸ¸", "ğŸµ", "ğŸ™ˆ", "ğŸ™‰", "ğŸ™Š",
            "ğŸ’", "ğŸ”", "ğŸ§", "ğŸ¦", "ğŸ¤", "ğŸ£", "ğŸ¥", "ğŸ¦†", "ğŸ¦…", "ğŸ¦‰",
            "ğŸ¦‡", "ğŸº", "ğŸ—", "ğŸ´", "ğŸ¦„", "ğŸ", "ğŸª±", "ğŸ›", "ğŸ¦‹", "ğŸŒ",
            "ğŸ", "ğŸœ", "ğŸª°", "ğŸª²", "ğŸª³", "ğŸ¦Ÿ", "ğŸ¦—", "ğŸ•·ï¸", "ğŸ•¸ï¸", "ğŸ¦‚",
            "ğŸ¢", "ğŸ", "ğŸ¦", "ğŸ¦–", "ğŸ¦•", "ğŸ™", "ğŸ¦‘", "ğŸ¦", "ğŸ¦", "ğŸ¦€",
            "ğŸ¡", "ğŸ ", "ğŸŸ", "ğŸ¬", "ğŸ³", "ğŸ‹", "ğŸ¦ˆ", "ğŸŠ", "ğŸ…", "ğŸ†",
            "ğŸ¦“", "ğŸ¦", "ğŸ¦§", "ğŸ¦£", "ğŸ˜", "ğŸ¦›", "ğŸ¦", "ğŸª", "ğŸ«", "ğŸ¦’",
            "ğŸ¦˜", "ğŸ¦¬", "ğŸƒ", "ğŸ‚", "ğŸ„", "ğŸ", "ğŸ–", "ğŸ", "ğŸ‘", "ğŸ¦™",
            "ğŸ", "ğŸ¦Œ", "ğŸ•", "ğŸ©", "ğŸ¦®", "ğŸ•â€ğŸ¦º", "ğŸˆ", "ğŸˆâ€â¬›", "ğŸª¶", "ğŸ“",
            "ğŸ¦ƒ", "ğŸ¦¤", "ğŸ¦š", "ğŸ¦œ", "ğŸ¦¢", "ğŸ¦©", "ğŸ•Šï¸", "ğŸ‡", "ğŸ¦", "ğŸ¦¨",
            "ğŸ¦¡", "ğŸ¦«", "ğŸ¦¦", "ğŸ¦¥", "ğŸ", "ğŸ€", "ğŸ¿ï¸", "ğŸ¦”", "ğŸ¾", "ğŸ‰",
            "ğŸ²", "ğŸŒµ", "ğŸ„", "ğŸŒ²", "ğŸŒ³", "ğŸŒ´", "ğŸªµ", "ğŸŒ±", "ğŸŒ¿", "â˜˜ï¸",
            "ğŸ€", "ğŸ", "ğŸª´", "ğŸ‹", "ğŸƒ", "ğŸ‚", "ğŸ", "ğŸ„", "ğŸš", "ğŸª¨",
            "ğŸŒ¾", "ğŸ’", "ğŸŒ·", "ğŸŒ¹", "ğŸ¥€", "ğŸŒº", "ğŸŒ¸", "ğŸŒ¼", "ğŸŒ»", "ğŸŒ",
            "ğŸŒ", "ğŸŒ›", "ğŸŒœ", "ğŸŒš", "ğŸŒ•", "ğŸŒ–", "ğŸŒ—", "ğŸŒ˜", "ğŸŒ‘", "ğŸŒ’",
            "ğŸŒ“", "ğŸŒ”", "ğŸŒ™", "ğŸŒ", "ğŸŒ", "ğŸŒ", "ğŸª", "ğŸ’«", "â­", "ğŸŒŸ",
            "âœ¨", "âš¡", "â˜„ï¸", "ğŸ’¥", "ğŸ”¥", "ğŸŒªï¸", "ğŸŒˆ", "â˜€ï¸", "ğŸŒ¤ï¸", "â›…",
            "ğŸŒ¥ï¸", "â˜ï¸", "ğŸŒ¦ï¸", "ğŸŒ§ï¸", "â›ˆï¸", "ğŸŒ©ï¸", "ğŸŒ¨ï¸", "â„ï¸", "â˜ƒï¸", "â›„",
            "ğŸŒ¬ï¸", "ğŸ’¨", "ğŸ’§", "ğŸ’¦", "â˜”", "â˜‚ï¸", "ğŸŒŠ", "ğŸŒ«ï¸"
        ]
        case 3: return [
            // Objects ç±»åˆ«çš„è¡¨æƒ…ç¬¦å·
            "ğŸ", "ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ‰", "ğŸ‡", "ğŸ“", "ğŸ«",
            "ğŸˆ", "ğŸ’", "ğŸ‘", "ğŸ¥­", "ğŸ", "ğŸ¥¥", "ğŸ¥", "ğŸ…", "ğŸ†", "ğŸ¥‘",
            "ğŸ«’", "ğŸ¥¦", "ğŸ¥¬", "ğŸ¥’", "ğŸŒ¶ï¸", "ğŸ«‘", "ğŸŒ½", "ğŸ¥•", "ğŸ§„", "ğŸ§…",
            "ğŸ¥”", "ğŸ ", "ğŸ¥", "ğŸ¥¯", "ğŸ", "ğŸ¥–", "ğŸ¥¨", "ğŸ§€", "ğŸ¥š", "ğŸ³",
            "ğŸ§ˆ", "ğŸ¥", "ğŸ§‡", "ğŸ¥“", "ğŸ¥©", "ğŸ—", "ğŸ–", "ğŸ¦´", "ğŸŒ­", "ğŸ”",
            "ğŸŸ", "ğŸ•", "ğŸ«“", "ğŸ¥ª", "ğŸ¥™", "ğŸ§†", "ğŸŒ®", "ğŸŒ¯", "ğŸ«”", "ğŸ¥—",
            "ğŸ¥˜", "ğŸ«•", "ğŸ¥«", "ğŸ", "ğŸœ", "ğŸ²", "ğŸ›", "ğŸ£", "ğŸ±", "ğŸ¥Ÿ",
            "ğŸ¦ª", "ğŸ¤", "ğŸ™", "ğŸš", "ğŸ˜", "ğŸ¥", "ğŸ¥ ", "ğŸ¥®", "ğŸ¢", "ğŸ¡",
            "ğŸ§", "ğŸ¨", "ğŸ¦", "ğŸ¥§", "ğŸ§", "ğŸ°", "ğŸ‚", "ğŸ®", "ğŸ­", "ğŸ¬",
            "ğŸ«", "ğŸ¿", "ğŸ©", "ğŸª", "ğŸŒ°", "ğŸ¥œ", "ğŸ«˜", "ğŸ¯", "ğŸ¥›", "ğŸ«—",
            "ğŸ¼", "â˜•", "ğŸ«–", "ğŸµ", "ğŸ§ƒ", "ğŸ¥¤", "ğŸ§‹", "ğŸ¶", "ğŸº", "ğŸ»",
            "ğŸ¥‚", "ğŸ·", "ğŸ¥ƒ", "ğŸ¸", "ğŸ¹", "ğŸ§‰", "ğŸ¾", "ğŸ§Š", "ğŸ¥„", "ğŸ´",
            "ğŸ½ï¸", "ğŸ¥£", "ğŸ¥¡", "ğŸ¥¢", "ğŸ§‚", "âš½", "ğŸ€", "ğŸˆ", "âš¾", "ğŸ¥",
            "ğŸ¾", "ğŸ", "ğŸ‰", "ğŸ¥", "ğŸ±", "ğŸª€", "ğŸ“", "ğŸ¸", "ğŸ’", "ğŸ‘",
            "ğŸ¥", "ğŸ", "ğŸªƒ", "ğŸ¥…", "â›³", "ğŸª", "ğŸ¹", "ğŸ£", "ğŸ¤¿", "ğŸ¥Š",
            "ğŸ¥‹", "ğŸ½", "ğŸ›¹", "ğŸ›¼", "ğŸ›·", "â›¸ï¸", "ğŸ¥Œ", "ğŸ¿", "â›·ï¸", "ğŸ‚",
            "ğŸª‚", "ğŸ‹ï¸", "ğŸ‹ï¸â€â™‚ï¸", "ğŸ‹ï¸â€â™€ï¸", "ğŸ¤¼", "ğŸ¤¼â€â™‚ï¸", "ğŸ¤¼â€â™€ï¸", "ğŸ¤¸â€â™€ï¸", "ğŸ¤¸", "ğŸ¤¸â€â™‚ï¸",
            "â›¹ï¸", "â›¹ï¸â€â™‚ï¸", "â›¹ï¸â€â™€ï¸", "ğŸ¤º", "ğŸ¤¾", "ğŸ¤¾â€â™‚ï¸", "ğŸ¤¾â€â™€ï¸", "ğŸŒï¸", "ğŸŒï¸â€â™‚ï¸", "ğŸŒï¸â€â™€ï¸",
            "ğŸ‡", "ğŸ§˜", "ğŸ§˜â€â™‚ï¸", "ğŸ§˜â€â™€ï¸", "ğŸ„", "ğŸ„â€â™‚ï¸", "ğŸ„â€â™€ï¸", "ğŸŠ", "ğŸŠâ€â™‚ï¸", "ğŸŠâ€â™€ï¸",
            "ğŸ¤½", "ğŸ¤½â€â™‚ï¸", "ğŸ¤½â€â™€ï¸", "ğŸš£", "ğŸš£â€â™‚ï¸", "ğŸš£â€â™€ï¸", "ğŸ§—", "ğŸ§—â€â™‚ï¸", "ğŸ§—â€â™€ï¸", "ğŸšµ",
            "ğŸšµâ€â™‚ï¸", "ğŸšµâ€â™€ï¸", "ğŸš´", "ğŸš´â€â™‚ï¸", "ğŸš´â€â™€ï¸", "ğŸ†", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸ…",
            "ğŸ–ï¸", "ğŸµï¸", "ğŸ—ï¸", "ğŸ«", "ğŸŸï¸", "ğŸª", "ğŸ¤¹", "ğŸ¤¹â€â™‚ï¸", "ğŸ¤¹â€â™€ï¸", "ğŸ­",
            "ğŸ©°", "ğŸ¨", "ğŸ¬", "ğŸ¤", "ğŸ§", "ğŸ¼", "ğŸ¹", "ğŸ¥", "ğŸ·", "ğŸº",
            "ğŸ¸", "ğŸª•", "ğŸ»", "ğŸ²", "â™Ÿï¸", "ğŸ¯", "ğŸ³", "ğŸ®", "ğŸ°", "ğŸ§©",
            "ğŸ¦¯", "ğŸ¦½", "ğŸ¦¼", "ğŸ›´", 
        ]
        case 4: return [
            // Places ç±»åˆ«çš„è¡¨æƒ…ç¬¦å·
            "ğŸ ", "ğŸ¡", "ğŸ˜ï¸", "ğŸšï¸", "ğŸ—ï¸", "ğŸ­", "ğŸ¢", "ğŸ¬", "ğŸ£", "ğŸ¤",
            "ğŸ¥", "ğŸ¦", "ğŸ¨", "ğŸª", "ğŸ«", "ğŸ©", "ğŸ’’", "ğŸ›ï¸", "â›ª", "ğŸ•Œ",
            "ğŸ•", "ğŸ›•", "ğŸ•‹", "â›©ï¸", "ğŸ›¤ï¸", "ğŸ›£ï¸", "ğŸ—¾", "ğŸ‘", "ğŸï¸", "ğŸŒ…",
            "ğŸŒ„", "ğŸŒ ", "ğŸ‡", "ğŸ†", "ğŸŒ‡", "ğŸŒ†", "ğŸ™ï¸", "ğŸŒƒ", "ğŸŒŒ", "ğŸŒ‰",
            "ğŸŒ", "ğŸ›«", "ğŸ›¬", "ğŸš‘", "ğŸš’", "ğŸš“", "ğŸš•", "ğŸš—", "ğŸš™", "ğŸšŒ",
            "ğŸš", "ğŸï¸", "ğŸš", "ğŸ›»", "ğŸšš", "ğŸš›", "ğŸšœ", "ğŸš²", "ğŸ›µ", "ğŸï¸",
            "ğŸ›º", "ğŸš¨", "ğŸš”", "ğŸš", "ğŸš˜", "ğŸš–", "ğŸš ", "ğŸš¡", "ğŸšŸ", "ğŸšƒ",
            "ğŸš‹", "ğŸš", "ğŸš", "ğŸš„", "ğŸš…", "ğŸšˆ", "ğŸš‚", "ğŸš†", "ğŸš‡", "ğŸšŠ",
            "ğŸš‰", "âœˆï¸", "ğŸ›©ï¸", "ğŸ’º", "ğŸ›°ï¸", "ğŸš€", "ğŸ›¸", "ğŸš", "ğŸ›¶", "â›µ",
            "ğŸš¤", "ğŸ›¥ï¸", "ğŸ›³ï¸", "â›´ï¸", "ğŸš¢", "âš“", "ğŸš§", "ğŸš¦", "ğŸš¥", "ğŸš",
            "ğŸ—¿", "ğŸ—½", "ğŸ—¼", "ğŸ°", "ğŸ¯", "ğŸŸï¸", "ğŸ¡", "ğŸ¢", "ğŸ ", "â›²",
            "â›±ï¸", "ğŸ–ï¸", "ğŸï¸", "ğŸœï¸", "ğŸŒ‹", "â›°ï¸", "ğŸ”ï¸", "ğŸ—»", "ğŸ•ï¸", "â›º",
            "ğŸ›–"
        ]
        case 5: return [
            // Symbols ç±»åˆ«çš„è¡¨æƒ…ç¬¦å·
            "â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ’™", "ğŸ’œ", "ğŸ–¤", "ğŸ¤", "ğŸ¤", "ğŸ’”",
            "â£ï¸", "ğŸ’•", "ğŸ’", "ğŸ’“", "ğŸ’—", "ğŸ’–", "ğŸ’˜", "ğŸ’", "ğŸ’Ÿ", "â˜®ï¸",
            "âœï¸", "â˜ªï¸", "ğŸ•‰ï¸", "â˜¸ï¸", "âœ¡ï¸", "ğŸ”¯", "ğŸ•", "â˜¯ï¸", "â˜¦ï¸", "ğŸ›",
            "â›", "â™ˆ", "â™‰", "â™Š", "â™‹", "â™Œ", "â™", "â™", "â™", "â™",
            "â™‘", "â™’", "â™“", "ğŸ†”", "âš›ï¸", "ğŸ‰‘", "â˜¢ï¸", "â˜£ï¸", "ğŸ“´", "ğŸ“³",
            "ğŸˆ¶", "ğŸˆš", "ğŸˆ¸", "ğŸˆº", "ğŸˆ·ï¸", "âœ´ï¸", "ğŸ†š", "ğŸ’®", "ğŸ‰", "ãŠ™ï¸",
            "ãŠ—ï¸", "ğŸˆ´", "ğŸˆµ", "ğŸˆ¹", "ğŸˆ²", "ğŸ…°ï¸", "ğŸ…±ï¸", "ğŸ†", "ğŸ†‘", "ğŸ…¾ï¸",
            "ğŸ†˜", "âŒ", "â­•", "ğŸ›‘", "â›”", "ğŸ“›", "ğŸš«", "ğŸ’¯", "ğŸ’¢", "â™¨ï¸",
            "ğŸš·", "ğŸš¯", "ğŸš³", "ğŸš±", "ğŸ”", "ğŸ“µ", "ğŸš­", "â—", "â•", "â“",
            "â”", "â€¼ï¸", "â‰ï¸", "ğŸ”…", "ğŸ”†", "ã€½ï¸", "âš ï¸", "ğŸš¸", "ğŸ”±", "âšœï¸",
            "ğŸ”°", "â™»ï¸", "âœ…", "ğŸˆ¯", "ğŸ’¹", "â‡ï¸", "âœ³ï¸", "â", "ğŸŒ", "ğŸ’ ",
            "â“‚ï¸", "ğŸŒ€", "ğŸ’¤", "ğŸ§", "ğŸš¾", "â™¿", "ğŸ…¿ï¸", "ğŸ›—", "ğŸˆ³", "ğŸˆ‚ï¸",
            "ğŸ›‚", "ğŸ›ƒ", "ğŸ›„", "ğŸ›…", "ğŸš¹", "ğŸšº", "ğŸš¼", "âš§", "ğŸš»", "ğŸš®",
            "ğŸ¦", "ğŸ“¶", "ğŸˆ", "ğŸ”£", "â„¹ï¸", "ğŸ”¤", "ğŸ”¡", "ğŸ” ", "ğŸ†–", "ğŸ†—",
            "ğŸ†™", "ğŸ†’", "ğŸ†•", "ğŸ†“", "0ï¸âƒ£", "1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£", "4ï¸âƒ£", "5ï¸âƒ£",
            "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£", "9ï¸âƒ£", "ğŸ”Ÿ", "ğŸ”¢", "#ï¸âƒ£", "*ï¸âƒ£", "âï¸", "â–¶ï¸",
            "â¸ï¸", "â¯ï¸", "â¹ï¸", "âºï¸", "â­ï¸", "â®ï¸", "â©", "âª", "â«", "â¬",
            "â—€ï¸", "ğŸ”¼", "ğŸ”½", "â¡ï¸", "â¬…ï¸", "â¬†ï¸", "â¬‡ï¸", "â†—ï¸", "â†˜ï¸", "â†™ï¸",
            "â†–ï¸", "â†•ï¸", "â†”ï¸", "â†ªï¸", "â†©ï¸", "â¤´ï¸", "â¤µï¸", "ğŸ”€", "ğŸ”", "ğŸ”‚",
            "ğŸ”„", "ğŸ”ƒ", "ğŸµ", "ğŸ¶", "â•", "â–", "â—", "âœ–ï¸", "â™¾ï¸", "ğŸ’²",
            "ğŸ’±", "â„¢ï¸", "Â©ï¸", "Â®ï¸", "ã€°ï¸", "â°", "â¿", "ğŸ”š", "ğŸ”™", "ğŸ”›",
            "ğŸ”", "ğŸ”œ", "âœ”ï¸", "â˜‘ï¸", "ğŸ”˜", "ğŸ”´", "ğŸŸ ", "ğŸŸ¡", "ğŸŸ¢", "ğŸ”µ",
            "ğŸŸ£", "âš«", "âšª", "ğŸŸ¤", "ğŸ”º", "ğŸ”»", "ğŸ”¸", "ğŸ”¹", "ğŸ”¶", "ğŸ”·",
            "ğŸ”³", "ğŸ”²", "â–ªï¸", "â–«ï¸", "â—¾", "â—½", "â—¼ï¸", "â—»ï¸", "ğŸŸ¥", "ğŸŸ§",
            "ğŸŸ¨", "ğŸŸ©", "ğŸŸ¦", "ğŸŸª", "â¬›", "â¬œ", "ğŸŸ«", "ğŸ”ˆ", "ğŸ”‡", "ğŸ”‰",
            "ğŸ”Š", "ğŸ””", "ğŸ”•", "ğŸ“£", "ğŸ“¢", "ğŸ‘ï¸â€ğŸ—¨ï¸", "ğŸ’¬", "ğŸ’­", "ğŸ—¯ï¸", "â™ ï¸",
            "â™£ï¸", "â™¥ï¸", "â™¦ï¸", "ğŸƒ", "ğŸ´", "ğŸ€„"
        ]
        default: return []
        }
    }
    
    // ä»ä¼ å…¥çš„åˆ†ç±»å’Œemojiæ•°ç»„ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªemoji
    private func randomEmoji() -> String {
        // éšæœºé€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼Œæ’é™¤"æœ€è¿‘ä½¿ç”¨"åˆ†ç±»
        let randomCategoryIndex = Int.random(in: 1..<emojiCategoryDefinitions.count)
        // ä»è¿™ä¸ªåˆ†ç±»ä¸­è·å–emoji
        let emojis = getEmojisForCategory(randomCategoryIndex)
        // éšæœºé€‰æ‹©ä¸€ä¸ªemoji
        return emojis.randomElement() ?? "ğŸ˜€"
    }
    
    // åŠ è½½å½“å‰åˆ†ç±»çš„emoji
    private func loadCurrentCategoryEmojis() {
        // ä½¿ç”¨å¼‚æ­¥åŠ è½½é¿å…é˜»å¡UI
        DispatchQueue.global(qos: .userInitiated).async {
            let emojis = self.getEmojisForCategory(self.selectedCategoryIndex)
            DispatchQueue.main.async {
                self.currentCategoryEmojis = emojis
            }
        }
    }
    
    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                // å½“å‰é€‰æ‹©çš„emojié¢„è§ˆåŒºåŸŸåŠéšæœºæŒ‰é’®
                ZStack(alignment: .center) {
                    // å½“å‰é€‰æ‹©çš„emoji (å±…ä¸­)
                ZStack {
                    RoundedRectangle(cornerRadius: 15)
                        .fill(Color(hex: selectedBackgroundColor))
                        .frame(width: 80, height: 80)
                    
                    Text(tempSelectedEmoji)
                        .font(.system(size: 40))
                
                        // éšæœºæŒ‰é’® (é¢„è§ˆå³ä¸‹è§’)
                    Button(action: {
                        // éšæœºé€‰æ‹©ä¸€ä¸ªæ–°emoji
                        tempSelectedEmoji = randomEmoji()
                        // ä¸å†ç«‹å³ä¿å­˜åˆ°æœ€è¿‘ä½¿ç”¨åˆ—è¡¨ï¼Œè€Œæ˜¯åœ¨ç¡®è®¤æ—¶ä¿å­˜
                    }) {
                            Image("dices")
                                .resizable()
                                .renderingMode(.template)
                                .scaledToFit()
                                .frame(width: 18, height: 18)
                                .frame(width: 36, height: 36)
                                .background(Color(UIColor.systemGray5).opacity(0.6))
                                .cornerRadius(10)
                                .foregroundColor(.primary)
                        }
                        .offset(x: 75, y: 20)  // ç›¸å¯¹äºé¢„è§ˆçš„å³ä¸‹è§’å®šä½
                    }
                }
                .padding(.top)
                .padding(.bottom, 40)
                
                // é€‰é¡¹å¡åˆ‡æ¢
                HStack {
                    Button(action: { selectedTab = 0 }) {
                        Text("Emoji")
                            .fontWeight(selectedTab == 0 ? .bold : .regular)
                            .padding(.bottom, 8)
                            .border(width: selectedTab == 0 ? 2 : 0, edges: [.bottom], color: .primary)
                    }
                    
                    Spacer()
                        .frame(width: 40)
                    
                    Button(action: { selectedTab = 1 }) {
                        Text("Text")
                            .fontWeight(selectedTab == 1 ? .bold : .regular)
                            .padding(.bottom, 8)
                            .border(width: selectedTab == 1 ? 2 : 0, edges: [.bottom], color: .primary)
                    }
                }
                .padding()
                
                if selectedTab == 0 {
                    // Emojiæ¨¡å¼
                    
                    // é¡¶éƒ¨å›¾æ ‡åˆ†ç±»
                    ScrollView(.horizontal, showsIndicators: false) {
                        HStack(spacing: 18) {
                            ForEach(0..<emojiCategoryDefinitions.count, id: \.self) { index in
                                Button(action: {
                                    // åˆ‡æ¢åˆ†ç±»æ—¶åŠ è½½å¯¹åº”çš„emoji
                                    if selectedCategoryIndex != index {
                                    selectedCategoryIndex = index
                                        loadCurrentCategoryEmojis()
                                    }
                                }) {
                                    Image(systemName: emojiCategoryDefinitions[index].symbol)
                                        .font(.system(size: 20))
                                        .foregroundColor(selectedCategoryIndex == index ? .accentColor : .gray)
                                        .frame(width: 44, height: 44)
                                        .background(
                                            Circle()
                                                .fill(selectedCategoryIndex == index ? 
                                                    Color.accentColor.opacity(0.1) : Color.clear)
                                        )
                                }
                                .buttonStyle(PlainButtonStyle())
                            }
                        }
                        .padding(.horizontal)
                    }
                    .padding(.vertical, 10)
                    
                    // emojiç½‘æ ¼
                    ScrollView(showsIndicators: false) {
                        LazyVGrid(columns: Array(repeating: GridItem(.flexible(), spacing: 8), count: 6), spacing: 12) {
                            ForEach(currentCategoryEmojis, id: \.self) { emoji in
                                Button(action: {
                                    // é€‰æ‹©emojiä½†ä¸å…³é—­ç•Œé¢
                                    tempSelectedEmoji = emoji
                                    // ä¸å†ç«‹å³ä¿å­˜åˆ°æœ€è¿‘ä½¿ç”¨ï¼Œè€Œæ˜¯åœ¨ç¡®è®¤æ—¶ä¿å­˜
                                }) {
                                        Text(emoji)
                                        .font(.system(size: 28))
                                        .frame(width: 44, height: 44)
                                        .background(tempSelectedEmoji == emoji ? Color.accentColor.opacity(0.2) : Color.clear)
                                        .cornerRadius(8)
                                }
                                .buttonStyle(PlainButtonStyle())
                            }
                        }
                        .padding()
                    }
                } else {
                    // Textæ¨¡å¼
                    VStack(spacing: 20) {
                        TextField("è¾“å…¥æ–‡å­—", text: $textInput)
                            .font(.system(size: 28))
                            .multilineTextAlignment(.center)
                            .frame(height: 60)
                            .background(Color(hex: selectedBackgroundColor).opacity(0.3))
                            .cornerRadius(10)
                            .padding(.horizontal, 40)
                            .onChange(of: textInput) { newValue in
                                // å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™é¢„è§ˆç¬¬ä¸€ä¸ªå­—ç¬¦
                                if !newValue.isEmpty {
                                    let firstChar = String(newValue.prefix(1))
                                    tempSelectedEmoji = firstChar
                                }
                            }
                        
                        Text("å°†å–ç¬¬ä¸€ä¸ªå­—ä½œä¸ºä¹ æƒ¯å›¾æ ‡ã€‚ä½ ä¹Ÿå¯ä»¥è¾“å…¥è‡ªå®šä¹‰çš„ emoji")
                            .font(.caption)
                            .foregroundColor(.secondary)
                            .padding(.top, 5)
                            .padding(.horizontal)
                        
                        Spacer()
                    }
                    .padding()
                }
                
                // ç§»é™¤åº•éƒ¨æ“ä½œæŒ‰é’®
                Spacer() // ç”¨Spaceræ›¿ä»£åº•éƒ¨æŒ‰é’®åŒºåŸŸ
            }
            .navigationTitle("é€‰æ‹©å›¾æ ‡")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("å–æ¶ˆ") {
                    presentationMode.wrappedValue.dismiss()
                    }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("ç¡®å®š") {
                        // ç¡®è®¤é€‰æ‹©ï¼Œæ›´æ–°ç»‘å®šå€¼
                        selectedEmoji = tempSelectedEmoji
                        // è¿™é‡Œæ‰ä¿å­˜åˆ°æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
                        saveEmojiToRecents(tempSelectedEmoji)
                        presentationMode.wrappedValue.dismiss()
                    }
                    .disabled(tempSelectedEmoji.isEmpty)
                }
            }
            .onAppear {
                // åœ¨è§†å›¾å‡ºç°æ—¶åŠ è½½å½“å‰åˆ†ç±»çš„emoji
                loadCurrentCategoryEmojis()
            }
        }
    }
}

// è¾¹æ¡†æ‰©å±•
struct EdgeBorder: Shape {
    var width: CGFloat
    var edges: [Edge]
    
    func path(in rect: CGRect) -> Path {
        var path = Path()
        for edge in edges {
            var line = Path()
            
            switch edge {
            case .top:
                line.move(to: CGPoint(x: rect.minX, y: rect.minY))
                line.addLine(to: CGPoint(x: rect.maxX, y: rect.minY))
            case .bottom:
                line.move(to: CGPoint(x: rect.minX, y: rect.maxY))
                line.addLine(to: CGPoint(x: rect.maxX, y: rect.maxY))
            case .leading:
                line.move(to: CGPoint(x: rect.minX, y: rect.minY))
                line.addLine(to: CGPoint(x: rect.minX, y: rect.maxY))
            case .trailing:
                line.move(to: CGPoint(x: rect.maxX, y: rect.minY))
                line.addLine(to: CGPoint(x: rect.maxX, y: rect.maxY))
            }
            
            path.addPath(line)
        }
        
        return path.strokedPath(StrokeStyle(lineWidth: width))
    }
}

extension View {
    func border(width: CGFloat, edges: [Edge], color: Color) -> some View {
        overlay(EdgeBorder(width: width, edges: edges).foregroundColor(color))
    }
} 