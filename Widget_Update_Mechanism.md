# Widget 数据更新机制

## Widget 更新原理

iOS 上的 Widget 更新遵循以下几种机制：

1. **定时更新**：在代码中设置的时间线策略（如每小时更新一次）
2. **主动刷新**：应用或 Widget 代码调用 `WidgetCenter.shared.reloadTimelines()` 方法
3. **用户交互**：用户与 Widget 交互时（如点击按钮）可以触发更新
4. **系统事件**：在特定系统事件（如时区更改）时

## 我们的实现

我们在以下情况下触发 Widget 更新：

1. **应用内数据变更**：当您在主应用中添加/编辑/删除习惯或进行打卡时
2. **Widget 直接交互**：当您直接在 Widget 上点击打卡按钮时
3. **定时更新**：默认每小时自动更新一次

## 故障排除

如果 Widget 仍然显示旧数据，可以尝试以下解决方法：

### 强制刷新 Widget
1. 在主屏幕上长按 Widget
2. 选择"编辑 Widget"
3. 不做任何更改，直接返回
4. 这有时会触发 Widget 刷新

### 检查 App Group 设置
1. 确认主应用和 Widget 扩展都正确配置了相同的 App Group
2. 确认您使用的是相同的数据键名 (`habits` 和 `habitLogs`)

### 重启测试设备
有时 Widget 缓存可能导致更新延迟，重启设备可以解决此问题

### 查看调试输出
我们添加了打印语句，您可以检查 Xcode 控制台是否有以下消息：
- "正在刷新 Widget..."
- "Widget 打卡操作已执行，正在请求刷新所有 Widget..."

## 系统限制

需要注意，iOS 对 Widget 更新有一些系统限制：

1. 为节省电池，系统可能会限制 Widget 更新频率
2. 在低功耗模式下，Widget 更新可能会延迟
3. 后台应用的 Widget 更新优先级较低

但我们的实现应该能确保在大多数正常使用情况下，Widget 数据能够及时更新。 